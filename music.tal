( music arranged by d_m <3 )

@music

&init
    ( adsr  len addr    vol dev )
    #0211 #0002 ;&square #11 #40 music/setup ( treble1 )
    #0211 #0002 ;&square #11 #50 music/setup ( treble2 )
    #0211 #0002 ;&square #11 #60 music/setup ( bass )

JMP2r

&setup ( adsr* len* addr* vol^ dev^ -> )
    STHk  #0e EOR DEO
    STHkr #0c EOR DEO2
    STHkr #0a EOR DEO2
    STHr  #08 EOR DEO2
    JMP2r

&play ( dev^ track* -> )
    .music-state/position LDZ2 ADD2 LDA
    DUP ?&sound POP !&rest &sound SWP DEO JMP2r
    &rest POP JMP2r

&update-envelopes ( -> )
       .music-state/position LDZ2 #0000 NEQ2 ?&b #0211 !&r
    &b .music-state/position LDZ2 #0100 NEQ2 ?&d #02ff
    &r DUP2 #48 DEO2 #58 DEO2
    &d JMP2r

&on-frame
    .music-state/counter LDZ ?&skip
    #4f ;&treble1 music/play
    #5f ;&treble2 music/play
    #6f ;&bass music/play
    .music-state/position LDZ2k INC2 #0180 DIV2k MUL2 SUB2 ROT STZ2
    music/update-envelopes
    &skip .music-state/counter LDZk INC #06 DIVk MUL SUB SWP STZ
    JMP2r

&square ff 00

( C  C# D  D# E  F  F# G  G# A  A# B  )
( 18 19 1a 1b 1c 1d 1e 1f 20 21 22 23 )
( 24 25 26 27 28 29 2a 2b 2c 2d 2e 2f )
( 30 31 32 33 34 35 36 37 38 39 3a 3b )
( 3c 3d 3e 3f 40 41 42 43 44 45 46 47 )
( 48 49 4a 4b 4c 4d 4e 4f 50 51 52 53 )
( 54 55 56 57 58 59 5a 5b 5c 5d 5e 5f )

&treble1
  [ 4c00 0000 4700 4800 ] [ 4a00 0000 4800 4700 ] [ 4500 0000 4500 4800 ] [ 4c00 0000 4a00 4800 ]
  [ 4700 0000 0000 4800 ] [ 4a00 0000 4c00 0000 ] [ 4800 0000 4500 0000 ] [ 4500 0000 0000 0000 ]
  [ 0000 4a00 0000 4d00 ] [ 5100 0000 4f00 4d00 ] [ 4c00 0000 0000 4800 ] [ 4c00 0000 4a00 4800 ]
  [ 4700 0000 4700 4800 ] [ 4a00 0000 4c00 0000 ] [ 4800 0000 4500 0000 ] [ 4500 0000 0000 0000 ]

  [ 4c00 0000 4700 4800 ] [ 4a00 0000 4800 4700 ] [ 4500 0000 4500 4800 ] [ 4c00 0000 4a00 4800 ]
  [ 4700 0000 0000 4800 ] [ 4a00 0000 4c00 0000 ] [ 4800 0000 4500 0000 ] [ 4500 0000 0000 0000 ]
  [ 0000 4a00 0000 4d00 ] [ 5100 0000 4f00 4d00 ] [ 4c00 0000 0000 4800 ] [ 4c00 0000 4a00 4800 ]
  [ 4700 0000 4700 4800 ] [ 4a00 0000 4c00 0000 ] [ 4800 0000 4500 0000 ] [ 4500 0000 0000 0000 ]

  [ 4c00 0000 0000 0000 ] [ 4800 0000 0000 0000 ] [ 4a00 0000 0000 0000 ] [ 4700 0000 0000 0000 ]
  [ 4800 0000 0000 0000 ] [ 4500 0000 0000 0000 ] [ 4400 0000 0000 0000 ] [ 4700 0000 0000 0000 ]
  [ 4c00 0000 0000 0000 ] [ 4800 0000 0000 0000 ] [ 4a00 0000 0000 0000 ] [ 4700 0000 0000 0000 ]
  [ 4800 0000 4c00 0000 ] [ 5100 0000 0000 0000 ] [ 5000 0000 0000 0000 ] [ 0000 0000 0000 0000 ]

&treble2
  [ 4700 0000 4400 4500 ] [ 4a00 4c4a 4500 4400 ] [ 3400 0000 0000 4500 ] [ 4800 0000 4700 4500 ]
  [ 4444 4000 4400 4500 ] [ 4700 0000 4800 0000 ] [ 4500 0000 4000 0000 ] [ 4000 0000 0000 0000 ]
  [ 3200 4100 0000 4500 ] [ 4800 4848 4700 4500 ] [ 4300 0000 0000 4000 ] [ 4300 4543 4100 4000 ]
  [ 4400 4000 4400 4500 ] [ 4700 4400 4800 4400 ] [ 4548 4000 4000 0000 ] [ 4000 0000 0000 0000 ]

  [ 4700 0000 4400 4500 ] [ 4a00 4c4a 4500 4400 ] [ 3400 0000 0000 4500 ] [ 4800 0000 4700 4500 ]
  [ 4444 4000 4400 4500 ] [ 4700 0000 4800 0000 ] [ 4500 0000 4000 0000 ] [ 4000 0000 0000 0000 ]
  [ 3200 4100 0000 4500 ] [ 4800 4848 4700 4500 ] [ 4300 0000 0000 4000 ] [ 4300 4543 4100 4000 ]
  [ 4400 4000 4400 4500 ] [ 4700 4400 4800 4400 ] [ 4548 4000 4000 0000 ] [ 4000 0000 0000 0000 ]

  [ 4800 0000 0000 0000 ] [ 4500 0000 0000 0000 ] [ 4700 0000 0000 0000 ] [ 4400 0000 0000 0000 ]
  [ 4500 0000 0000 0000 ] [ 4000 0000 0000 0000 ] [ 3400 0000 0000 0000 ] [ 0000 0000 0000 0000 ]
  [ 4800 0000 0000 0000 ] [ 4500 0000 0000 0000 ] [ 4700 0000 0000 0000 ] [ 4400 0000 0000 0000 ]
  [ 4500 0000 4800 0000 ] [ 4c00 0000 0000 0000 ] [ 4a00 0000 0000 0000 ] [ 0000 0000 0000 0000 ]

&bass
  [ 2800 3400 2800 3400 ] [ 2800 3400 2800 3400 ] [ 2d00 3900 2d00 3900 ] [ 2d00 3900 2d00 3900 ]
  [ 2c00 3800 2c00 3800 ] [ 2800 3400 2800 3400 ] [ 2d00 3900 2d00 3900 ] [ 2d00 3900 2f00 3000 ]
  [ 3200 2600 0000 2600 ] [ 0000 2600 2d00 2900 ] [ 2400 3000 0000 3000 ] [ 2400 2b00 2b00 0000 ]
  [ 2f00 3b00 0000 3b00 ] [ 0000 3400 0000 3800 ] [ 2d00 3400 2d00 3400 ] [ 2d00 0000 0000 0000 ]

  [ 2800 3400 2800 3400 ] [ 2800 3400 2800 3400 ] [ 2d00 3900 2d00 3900 ] [ 2d00 3900 2d00 3900 ]
  [ 2c00 3800 2c00 3800 ] [ 2800 3400 2800 3400 ] [ 2d00 3900 2d00 3900 ] [ 2d00 3900 2f00 3000 ]
  [ 3200 2600 0000 2600 ] [ 0000 2600 2d00 2900 ] [ 2400 3000 0000 3000 ] [ 2400 2b00 2b00 0000 ]
  [ 2f00 3b00 0000 3b00 ] [ 0000 3400 0000 3800 ] [ 2d00 3400 2d00 3400 ] [ 2d00 0000 0000 0000 ]

  [ 3900 4000 3900 4000 ] [ 3900 4000 3900 4000 ] [ 3800 4000 3800 4000 ] [ 3800 4000 3800 4000 ]
  [ 3900 4000 3900 4000 ] [ 3900 4000 3900 4000 ] [ 3800 4000 3800 4000 ] [ 0000 0000 0000 0000 ]
  [ 3900 4000 3900 4000 ] [ 3900 4000 3900 4000 ] [ 3800 4000 3800 4000 ] [ 3800 4000 3800 4000 ]
  [ 3900 4000 3900 4000 ] [ 3900 4000 3900 4000 ] [ 3800 4000 3800 4000 ] [ 0000 0000 0000 0000 ]

&drums
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]

  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]

  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
  [ 0000 2000 0000 2000 ] [ 0000 2020 0000 2000 ] [ 0000 2000 0000 2000 ] [ 0000 2000 2000 2000 ]
